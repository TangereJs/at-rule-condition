<link rel="import" href="../tangere/tangere.html">
<link rel="import" href="../at-theme/at-theme.html">
<link rel="import" href="../at-i18n/at-i18n-behavior.html">
<link rel="import" href="../at-elements/at-designer-elements.html">
<link rel="import" href="at-rule-conditions-styles.html" />
<link rel="import" href="../at-carbon-menu-button/at-carbon-menu-button.html" />

<dom-module id="at-rule-conditions">
  <template>
    <style include="at-rule-conditions-styles">
      :host { 
        display: block; 
        box-sizing: border-box; 
      }
    </style>
    <h4 class="conditions-title" disabled$="[[disabled]]" hidden$="[[hideLabel]]" >{{label}}</h4>
    <div id="conditionsHtmlContainer"></div>
  </template>
  <script>
    'use strict';
    // ----------------------------------------
    // at-rule-conditions definition
    // ----------------------------------------
    Polymer({
      is: 'at-rule-conditions',
      properties: {

        label: {
          type: String,
          value: 'When these conditions are met ...'
        },

        hideLabel: {
          type: Boolean,
          value: false
        },

        disabled: {
          type: Boolean,
          value: false,
          observer: '_disabledChanged'
        },

        schema: {
          type: Object,
          value: function() {
            return {};
          }
        },

        config: {
          type: Array,
          xtype: 'json',
          value: function() {
            return [];
          }
        },

        value: {
          type: Object,
          value: function() {
            return {
              kind: "all",
              conditions: [] // "all is needed because add rule interface is not displayed if conditions object is empty
            };
          }
        }
      },

      observers: [ '_handleConfigSchemaValueChanged(config, schema, value)' ],
      
      ready: function() {
        this._isReady = true;
      },

      _isString: function(obj) {
        return Object.prototype.toString.apply(obj) === "[object String]";
      },

      _isArray: function(obj) {
        return Object.prototype.toString.apply(obj) === "[object Array]";
      },

      _checkConfigValid: function(param) {
        return Object.prototype.toString.apply(param) === "[object Array]";
      },
      
      _isObject: function(obj) {
        return Object.prototype.toString.apply(obj) === "[object Object]";
      },

      _checkSchemaValid: function(param) {
        if (!this._isObject(param)) { return false; }
        if (!param.hasOwnProperty('properties')) { return false; }
        if (!this._isObject(param.properties)) { return false; }
        return true;
      },

      _checkValueValid: function(param) {
        if (!this._isObject(param)) { return false; }
        if (!param.hasOwnProperty('kind') || !param.hasOwnProperty('conditions')) { return false; }
        if (!this._isString(param.kind) || !this._isArray(param.conditions)) { return false; }
        return true;
      },

      _isSchemaEmpty: function(schema) {
        return Object.keys(schema.properties).length === 0;
      },

      _handleConfigSchemaValueChanged: function(newConfig, newSchema, newValue) {
        var config;
        var schema;
        var value;
        
        if (!this._isReady || this._handlingInProgress) { return; }
                        
        // *ij* newConfig can either be an array object [] or a JSON string of an array "[]"        
        if (this._isString(newConfig) && newConfig !== "") {
          try {
            var parsedConfig = JSON.parse(newConfig);
            this._handlingInProgress = true;
            this.config = parsedConfig;
            this._handlingInProgress = false;
          } catch (e) {
            this._handlingInProgress = true;
            this.config = this.properties.config.value();
            this._handlingInProgress = false;
          }
        }

        // newSchema can iether be an object { properties: {} } or a JSON string of an object { "properties": {} }
        if (this._isString(newSchema) && newSchema !== "") {
          try {
            var parsedSchema = JSON.parse(newSchema);
            this._handlingInProgress = true;
            this.schema = parsedSchema;
            this._handlingInProgress = false;
          } catch (e) {
            this._handlingInProgress = true;
            this.schema = this.properties.schema.value();
            this._handlingInProgress = false;
          }
        }

        // newValue can iether be an array [] or a JSON string of an array "[]"
        if (this._isString(newValue) && newValue !== "") {
          try {
            var parsedValue = JSON.parse(newValue);
            this._handlingInProgress = true;
            this.value = parsedValue;
            this._handlingInProgress = false;
          } catch (e) {
            this._handlingInProgress = true;
            this.value = this.properties.value.value();
            this._handlingInProgress = false;
          }
        }

        var isConfigValid = this._checkConfigValid(this.config);
        var isSchemaValid = this._checkSchemaValid(this.schema);
        var isValueValid  = this._checkValueValid(this.value);

        if (!isValueValid) {
          this._handlingInProgress = true;
          this.value = this.properties.value.value();
          this._handlingInProgress = false;
        }

        if (isSchemaValid && !this._isSchemaEmpty(this.schema)) {
          // use schema
          // convert schema to config and use config and value
          var t_config = this.__conditionsHelperFunctions.schemaToConfig(this.schema);
          this._handlingInProgress = true;
          this.config = t_config.value.fields;
          this._handlingInProgress = false;
        } else if (!isConfigValid) {
          // use initial value for config
          this._handlingInProgress = true;
          this.config = this.properties.config.value();
          this._handlingInProgress = false;
        }

        if (Object.keys(this.config).length === 0) return;

        Polymer.dom(this.$.conditionsHtmlContainer).innerHTML = '';
        this.buildConditionsHtml(this.$.conditionsHtmlContainer, this.config, this.value);
        this._disabledChanged(this.disabled);
      },

      _disabledChanged: function(newValue, oldValue) {
        var
          selectIndex,
          selectElement,
          selectElements = [],
          inputIndex,
          inputElement,
          inputElements = [],
          aIndex,
          aElement,
          aElements = [],
          tmp;

        if (!this._isReady) {
          return;
        }

        var queryRoot = Polymer.dom(this.$.conditionsHtmlContainer);
        var classesList = ['.all-any-none', '.text', '.conditions-menu', '.-arc-remove', '.field', '.operator', '.compareTo', '.value'];

        classesList.forEach(function(className, index) { 
          tmp = queryRoot.querySelectorAll(className);
            
          tmp.forEach(function(element, index) { 
            element.disabled = newValue;
          });

          if (className === '.text') {
            tmp.forEach(function(element, index) { 
              if (newValue){
                element.setAttribute('disabled', newValue);
              } else {
                element.removeAttribute('disabled', newValue);
              }
            });            
          }
        });
      },

      pushArray1IntoArray2: function(array1, array2) {
        var
          arr1Index;

        for (arr1Index = 0; arr1Index < array1.length; arr1Index += 1) {
          array2.push(array1[arr1Index]);
        }
      },
      // ------------------------------
      // for the specified updatePath inserts the data for the condition into conditions array
      // and fires the value-changed event
      // ------------------------------
      addCondition: function(updatePath, data) {
        var conditionData = this.get(updatePath, this.value);
        conditionData.push(data);
        this.fire('value-changed', {
          value: this.value
        }, { bubbles: false });
      },
      // ------------------------------
      // for the specified updatePath removes the data for the condition from conditions array
      // updates the updatePaths for elements where necessary
      // and fires the value-changed event
      // ------------------------------
      removeCondition: function(updatePath) {
        var pathParts = this._getPathParts(updatePath);
        var removePath = pathParts[pathParts.length - 1];
        pathParts.splice(pathParts.length - 1, 1);

        var conditions = this.get(pathParts, this.value);
        var removeIndex = parseInt(removePath);

        for (var i = removeIndex + 1; i < conditions.length; i++) {
          // create the container selector
          var containerSelector = '[data-update-path=\'' + pathParts.join('.') + '.' + i + '\']';
          // find the condition / rule div
          var container = Polymer.dom(this.$.conditionsHtmlContainer).querySelector(containerSelector);
          // start the update process on the div
          var oldPath = pathParts.join('.') + '.' + i;
          var newPath = pathParts.join('.') + '.' + (i - 1);
          if (Polymer.dom(container).classList.contains('rule')) {
            this.updateLeafPath(container, oldPath, newPath);
          } else if (Polymer.dom(container).classList.contains('-arc-conditional')) {
            this.updateNodePath(container, oldPath, newPath);
          }
        }

        conditions.splice(removePath, 1);

        this.fire("value-changed", {
          value: this.value
        }, { bubbles: false });
      },
      // ------------------------------
      // updates the updatePath for the condition (contains zero or more rules or conditions)
      // ------------------------------
      updateNodePath: function(container, oldPath, newPath) {
        // update container's attribute
        this.updatePathAttribute(container, oldPath, newPath);

        // update kind select
        var kindSelect = Polymer.dom(container).querySelector('.all-any-none');
        this.updatePathAttribute(kindSelect, oldPath, newPath);

        // update buttons
        var addRuleButton = Polymer.dom(container).querySelector('.conditions-menu');
        this.updatePathAttribute(addRuleButton, oldPath, newPath);
        // var addConditionButton = Polymer.dom(container).querySelector('.add-condition');
        // this.updatePathAttribute(addConditionButton, oldPath, newPath);
        var removeButton = Polymer.dom(container).querySelector('.-arc-remove');
        this.updatePathAttribute(removeButton, oldPath, newPath);

        var childNodes = Polymer.dom(container).childNodes,
          i, child, length = childNodes.length;

        for (i = 0; i < length; i++) {
          child = childNodes[i];
          if (child.classList.contains('rule')) {
            this.updateLeafPath(child, oldPath, newPath);
          } else if (child.classList.contains('-arc-conditional')) {
            this.updateNodePath(child, oldPath, newPath);
          }
        }
      },
      // ------------------------------
      // updates the updatePath for the rule
      // ------------------------------
      updateLeafPath: function(leaf, oldPath, newPath) {
        this.updatePathAttribute(leaf, oldPath, newPath);

        var fieldSelect = Polymer.dom(leaf).querySelector('.field');
        var operatorSelect = Polymer.dom(leaf).querySelector('.operator');
        var compareToSelect = Polymer.dom(leaf).querySelector('.compareTo');
        var value = Polymer.dom(leaf).querySelector('.value');
        var removeButton = Polymer.dom(leaf).querySelector('.-arc-remove');

        this.updatePathAttribute(fieldSelect, oldPath, newPath);
        this.updatePathAttribute(operatorSelect, oldPath, newPath);
        if (compareToSelect) {
          this.updatePathAttribute(compareToSelect, oldPath, newPath);
        }
        if (value) {
          this.updatePathAttribute(value, oldPath, newPath);
        }
        this.updatePathAttribute(removeButton, oldPath, newPath);
      },
      // ------------------------------
      // helper function which updates the data-update-path attribute
      // ------------------------------
      updatePathAttribute: function(node, oldPath, newPath) {
        var updatePath = node.getAttribute('data-update-path');
        updatePath = updatePath.replace(oldPath, newPath);
        Polymer.dom(node).setAttribute('data-update-path', updatePath);
      },
      // ----------------------------------------
      // at-rule-conditions helper functions
      // ----------------------------------------
      __conditionsHelperFunctions: {
        // ----------------------------------------
        // validates the schema object
        // schema object must contain property 'properties'
        // ----------------------------------------
        isSchemaValid: function(schema) {
          var
            result = false;

          result = schema.hasOwnProperty('properties');

          return result;
        },
        // ----------------------------------------
        // converts schema to config and data
        // schema object must contain property 'properties'
        // ----------------------------------------
        schemaToConfig: function(schema) {
          var result = {
              value: {
                fields: [],
                data: {
                  kind: "all",
                  conditions: []
                }
              },
              hasErrors: false,
              errors: []
            },
            properties = schema.properties,
            propName, // property name
            propDef, // property definition
            propLabel, // property title
            propType, // property type
            field, // a new field to be added to result.value.fields
            hasCompareTargets, // bool that tells that current property has compare targets
            compareTargets, // for a given field holds other fields whose value can be compared to the given field's value
            indexOfDash // for xtype="code-*"
          ;

          var _anyField = {
            label: '_any',
            name: '_any',
            operators: [
              this.createOperatorDef("if changed", "ifChanged", "none"),
              this.createOperatorDef("if not changed", "ifNotChanged", "none"),
            ],
            options: []
          };

          result.value.fields.push(_anyField);

          // we want to iterate over all properties of schema.properties
          for (propName in properties) {
            propDef = properties[propName];
            propLabel = this.getPropertyLabel(propName, propDef);

            field = {
              label: propLabel,
              name: propName,
              operators: [],
              options: []
            }

            result.value.fields.push(field);

            // *ij* if its needed to compare fields value against a predefined list of values
            //  propDef needs to have an additional property that will provide the list of values

            propType = this.getPropertyType(propDef);
            compareTargets = this.getCompareTargets(propName, properties);
            hasCompareTargets = compareTargets.length > 0;

            switch (propType) {
              case "file":
              case "image":
              case "code":
              case "marked":
                field.operators.push(this.createOperatorDef("is equal to", "equalTo", "select"));
                field.operators.push(this.createOperatorDef("it not equal to", "notEqualTo", "select"));
                field.operators.push(this.createOperatorDef("is present", "present", "none"));
                field.operators.push(this.createOperatorDef("is blank", "blank", "none"));

                field.options.push(this.createFieldOption("Static", "static", undefined, propType));
                if (hasCompareTargets) {
                  field.options.push(this.createFieldOption("Field", "field", compareTargets, "select"));
                }
                break;
              case "string":
              case "password":
              case "textarea":
              case "random":
              case "cron":
                field.operators.push(this.createOperatorDef("is equal to", "equalTo", "select"));
                field.operators.push(this.createOperatorDef("it not equal to", "notEqualTo", "select"));
                field.operators.push(this.createOperatorDef("is present", "present", "none"));
                field.operators.push(this.createOperatorDef("is blank", "blank", "none"));
                field.operators.push(this.createOperatorDef("includes", "includes", "select"));
                field.operators.push(this.createOperatorDef("matches regex", "matchesRegex", "select"));
                field.operators.push(this.createOperatorDef("is less than", "lessThan", "select"));
                field.operators.push(this.createOperatorDef("is less than or equal to", "lessThanEqual", "select"));
                field.operators.push(this.createOperatorDef("is greater than", "greaterThan", "select"));
                field.operators.push(this.createOperatorDef("is greater than or equal to", "greaterThanEqual", "select"));

                field.options.push(this.createFieldOption("Static", "static", undefined, propType));
                if (hasCompareTargets) {
                  field.options.push(this.createFieldOption("Field", "field", compareTargets, "select"));
                }
                break;
              case "number":
              case "date":
              case "time":
              case "datetime":
              case "daterange":
                field.operators.push(this.createOperatorDef("is equal to", "equalTo", "select"));
                field.operators.push(this.createOperatorDef("it not equal to", "notEqualTo", "select"));
                field.operators.push(this.createOperatorDef("is present", "present", "none"));
                field.operators.push(this.createOperatorDef("is blank", "blank", "none"));
                field.operators.push(this.createOperatorDef("is less than", "lessThan", "select"));
                field.operators.push(this.createOperatorDef("is less than or equal to", "lessThanEqual", "select"));
                field.operators.push(this.createOperatorDef("is greater than", "greaterThan", "select"));
                field.operators.push(this.createOperatorDef("is greater than or equal to", "greaterThanEqual", "select"));

                field.options.push(this.createFieldOption("Static", "static", undefined, propType));
                if (hasCompareTargets) {
                  field.options.push(this.createFieldOption("Field", "field", compareTargets, "select"));
                }
                break;
              case "boolean":
              case "toggle":
                field.operators.push(this.createOperatorDef("is equal to", "equalTo", "select"));
                field.operators.push(this.createOperatorDef("it not equal to", "notEqualTo", "select"));
                var trueFalseOptionsArray = [{
                  name: "true",
                  label: "true"
                }, {
                  name: "false",
                  label: "false"
                }];

                field.options.push(this.createFieldOption("Static", "static", undefined, propType));
                if (hasCompareTargets) {
                  field.options.push(this.createFieldOption("Field", "field", compareTargets, "select"));
                }
                break;
              case "enum":
              case "radio":
                field.operators.push(this.createOperatorDef("is equal to", "equalTo", "select"));
                field.operators.push(this.createOperatorDef("it not equal to", "notEqualTo", "select"));
                field.operators.push(this.createOperatorDef("is present", "present", "none"));
                field.operators.push(this.createOperatorDef("is blank", "blank", "none"));

                var
                  enumOptions = this.getEnumOptions(propDef),
                  hasEnumOptions = enumOptions.length > 0;

                if (hasEnumOptions) {
                  field.options.push(this.createFieldOption("Static", "static", enumOptions, propType));
                } else {
                  field.options.push(this.createFieldOption("Static", "static", undefined, "text"));
                }
                if (hasCompareTargets) {
                  field.options.push(this.createFieldOption("Field", "field", compareTargets, "select"));
                }
                break;
              case "lookup":
                field.operators.push(this.createOperatorDef("is equal to", "equalTo", "select"));
                field.operators.push(this.createOperatorDef("it not equal to", "notEqualTo", "select"));

                field.operators.push(this.createOperatorDef("is present", "present", "none"));
                field.operators.push(this.createOperatorDef("is blank", "blank", "none"));

                enumOptions = this.getEnumOptions(propDef);
                hasEnumOptions = enumOptions.length > 1;

                if (hasEnumOptions) {
                  field.options.push(this.createFieldOption("Static", "static", enumOptions, "select"));
                } else {
                  field.options.push(this.createFieldOption("Static", "static", undefined, propType));
                }
                if (hasCompareTargets) {
                  field.options.push(this.createFieldOption("Field", "field", compareTargets, "select"));
                }
                break;
              case "section":
                break;
            }
            // end switch (propType)

            field.operators.push(this.createOperatorDef("if changed", "ifChanged", "none"));
            field.operators.push(this.createOperatorDef("if not changed", "ifNotChanged", "none"));
          }

          return result;
        },
        // ----------------------------------------
        // calculates what is the label for the property
        // ----------------------------------------
        getPropertyLabel: function(propName, propDef) {
          var result = this.capitalize(propName);

          if (propDef.hasOwnProperty('title') && propDef.title !== '') {
            result = propDef.title;
          } else if (propDef.hasOwnProperty('description' && propDef.description !== '')) {
            result = propDef.description;
          }

          return result;
        },
        // ----------------------------------------
        // calculates what is property's type
        // ----------------------------------------
        getPropertyType: function(propDef) {
          var result = propDef.type;

          if (result === "boolean" && propDef.hasOwnProperty('xtype') && propDef.xtype !== "") {
            result = propDef.xtype;
          }

          if (result === "string" && propDef.hasOwnProperty('xtype') && propDef.xtype !== "") {
            result = propDef.xtype;
            if (result.indexOf('-') != -1) {
              var indexOfDash = result.indexOf('-');
              result = result.slice(0, indexOfDash);
            }
          }

          if (result === "string" && (!propDef.hasOwnProperty('xtype') || propDef.xtype === '') && propDef.hasOwnProperty('enum') && this.isArray(propDef.enum)) {
            result = "enum";
          }

          if (result === 'bool') {
            result = "boolean"
          }

          return result;
        },
        // ----------------------------------------
        // for a given property name finds the other properties which value can be compared to this property's value
        // ----------------------------------------
        getCompareTargets: function(propName, properties) {
          var
            result = [],
            sourceDef = properties[propName],
            targetDef = {},
            propNameIndex;

          for (propNameIndex in properties) {
            if (propName !== propNameIndex) { // if names are differenct do the check
              targetDef = properties[propNameIndex];
              if (this.isCompareTarget(sourceDef, targetDef)) {
                result.push({
                  label: this.getPropertyLabel(propNameIndex, targetDef),
                  name: propNameIndex
                });
              }
            }
          }

          return result;
        },
        // ----------------------------------------
        // returns true if sourceDef and targetDef define elements whose value can be compared
        // ----------------------------------------
        isCompareTarget: function(sourceDef, targetDef) {
          if (sourceDef.type !== targetDef.type) {
            // if both have different type they are not compatible
            return false;
          }

          if (sourceDef.xtype === undefined && targetDef.xtype === undefined) {
            // if both are of the same type and do not have xtype and they are compatible
            return true;
          }

          if ((sourceDef.xtype === undefined && targetDef.xtype !== undefined) || (sourceDef.xtype !== undefined && targetDef.xtype === undefined)) {
            // if both have same type but one has xtype and other doesn't they are not compatible
            return false;
          }

          if (sourceDef.xtype !== targetDef.xtype) {
            // if both have same type but different xtypes they are not compatible
            return false;
          }

          // at this point both have the same type and same xtype

          if (sourceDef.xtype === 'enum') {
            // compare xvaluelists
            if (sourceDef.xvaluelist === undefined || targetDef.xvaluelist === undefined || sourceDef.xvaluelist !== targetDef.xvaluelist) {
              // if any of the two doesn't have xvaluelist or xvaluelists are different they are not compatible
              return false;
            }
          } else if (sourceDef.xtype === 'lookup') {
            if (sourceDef.xurl === undefined || targetDef.xurl === undefined || sourceDef.xurl !== targetDef.xurl) {
              // if any of the two doesn't have xurl or xurls are different they are not compatible
              return false;
            }
          } // else {
          // xtype is not recognized; return false
          //return false;
          //}

          // source and target are compatible; return true
          return true;
        },
        getEnumOptions: function(propDef) {
          var
            result = [],
            value, valueList = [""],
            trimedValue, index, length;

          if (propDef.xvaluelist && this.isArray(propDef.xvaluelist)) {
            result = propDef.xvaluelist;
            return result;
          } else if (propDef.xvaluelist !== undefined && propDef.xvaluelist !== "" && propDef.xvaluelist.indexOf(',') !== -1) {
            valueList = propDef.xvaluelist.split(',');
          } else if (propDef.enum && this.isArray(propDef.enum)) {
            valueList = propDef.enum;
          }

          length = valueList.length;
          for (index = 0; index < length; index += 1) {
            value = valueList[index];
            trimedValue = value.trim();
            result.push({
              name: trimedValue,
              label: this.capitalize(trimedValue)
            });
          }

          return result;
        },
        // ----------------------------------------
        // creates an operator definition
        // ----------------------------------------
        createOperatorDef: function(label, name, fieldType) {
          var result = {
            label: label,
            name: name,
            fieldType: fieldType
          }

          return result;
        },
        // ----------------------------------------
        // creates a new field option
        // ----------------------------------------
        createFieldOption: function(label, name, options, fieldType) {
          var result = {
            label: label,
            name: name
          };
          if (options !== undefined && this.isArray(options)) {
            result.options = options;
          }
          if (fieldType !== undefined && this.isString(fieldType)) {
            result.fieldType = fieldType;
          }

          return result;
        },
        // ----------------------------------------
        // capitalizes the first letter of a word
        // ----------------------------------------
        capitalize: function(string) {
          return string.charAt(0).toUpperCase() + string.slice(1);
        },
        // ----------------------------------------
        // tests if obj is a javascript array
        // ----------------------------------------
        isArray: function(obj) {
          return Object.prototype.toString.call(obj) === "[object Array]";
        },
        isString: function(obj) {
          return Object.prototype.toString.call(obj) === "[object String]";
        }
      },
      // ----------------------------------------
      // end of at-rule-conditions helper functions
      // ----------------------------------------

      // ----------------------------------------
      // at-rule-conditions html helper functions
      // ----------------------------------------
      buildConditionsHtml: function(htmlContainer, fields, data) {
        var updatePath = '';
        this.buildNodeHtml(htmlContainer, fields, data, updatePath);
      },
      buildNodeHtml: function(htmlContainer, fields, data, updatePath) {
        var kind = data.kind;
        var index;
        var condition;
        var length = data.conditions.length;
        var isLeaf;
        var self = this;
        var _fields = fields;

        // ----------------------------------------
        // build all-any-none select
        // ----------------------------------------
        var conditionsDiv = document.createElement('div');
        Polymer.dom(conditionsDiv).classList.add('-arc-conditional');
        Polymer.dom(conditionsDiv).classList.add(kind);
        Polymer.dom(conditionsDiv).setAttribute('data-update-path', updatePath);
        Polymer.dom(htmlContainer).appendChild(conditionsDiv);

        var allAnyNoneWrapper = document.createElement('div');
        Polymer.dom(allAnyNoneWrapper).classList.add('all-any-none-wrapper');

        var allAnyNoneSelect = document.createElement('at-form-lookup');
        Polymer.dom(allAnyNoneSelect).classList.add('all-any-none');
        Polymer.dom(allAnyNoneSelect).setAttribute('data-update-path', this.createPath(updatePath, 'kind'));

        allAnyNoneSelect.xvaluelist = [
          { title: "All", value: "all" },
          { title: "Any", value: "any" },
          { title: "None", value: "none" }
        ];
        allAnyNoneSelect.value = kind;
        allAnyNoneSelect.addEventListener('value-changed', this._handleValueChanged.bind(this));

        Polymer.dom(allAnyNoneWrapper).appendChild(allAnyNoneSelect);

        var span = document.createElement('span');
        Polymer.dom(span).innerHTML = "of the following conditions:";
        Polymer.dom(span).classList.add('text');

        Polymer.dom(allAnyNoneWrapper).appendChild(span);
        Polymer.dom(conditionsDiv).appendChild(allAnyNoneWrapper);

        // ------------------------------
        // create add condition button
        // ------------------------------

        var menuItems = [
          { title: 'Add condition', value: "addCondition", icon: "now:plus"},
          { title: 'Add sub-condition', value: "addSubCondition", icon: "now:plus"}
        ];
        var addMenu = document.createElement('at-carbon-menu-button');        
        addMenu.items = menuItems;
        addMenu.icon = "now:plus"
        Polymer.dom(addMenu).classList.add('conditions-menu');
        Polymer.dom(addMenu).setAttribute('data-update-path', this.createPath(updatePath, 'conditions'));
        addMenu.addEventListener('value-changed', function(event){
          var value = event.detail.value;

          var _fields = fields;
          var _htmlContainer = conditionsDiv;
          var aField = _fields[0];
          var data = {};
          
          var updatePath = event.currentTarget.getAttribute('data-update-path');
          var conditionData = self.get(updatePath, self.value);
          var index = conditionData.length;
          var newPath = self.createPath(updatePath, index);
          
          // initialValue update
          // previously initialValue was set to empty string because originally strings was the only thing
          // one was allowed to compare to
          var propDef;
          if (aField.name === "_any") {
            propDef = {
              type: "string",
            };
            initialValue = "";

          } else {
            propDef = self.schema.properties[aField.name];
            var initialValue = '';
            if (propDef.hasOwnProperty('default')) {
              initialValue = propDef.default;
            }
          }
          
          // we have special handling for initial boolean values
          // if initial value is "", "false", "0" or 0 we 'convert' that to false (boolean literal false)
          // everything else we 'convert' to true
          if (propDef.type === "boolean") {
            initialValue = ['', 'false', '0', 0].indexOf(initialValue) > -1 ? false : true;
          }

          if (value === "addCondition") {
            data = {
              name: aField.name,
              operator: aField.operators[0].name,
              compareTo: "text",
              value: initialValue
            };
            self.buildLeafHtml(_htmlContainer, _fields, data, newPath);
          } else if (value === "addSubCondition") {
            data = {
              kind: "all",
              conditions: [{
                name: aField.name,
                operator: aField.operators[0].name,
                compareTo: "text",
                value: initialValue
              }]
            };
            self.buildNodeHtml(_htmlContainer, _fields, data, newPath);
          }

          self.addCondition(updatePath, data);
        });
        Polymer.dom(conditionsDiv).appendChild(addMenu);

        // ------------------------------
        // create remove condition / sub-condition button
        // ------------------------------
        var removeLink = document.createElement('at-carbon-icon-button');
        Polymer.dom(removeLink).classList.add('-arc-remove');
        removeLink.icon = "now:trash";
        removeLink.color = "red";
        Polymer.dom(removeLink).setAttribute('data-update-path', updatePath);

        removeLink.addEventListener('tap', function(e) {
          var remElem = conditionsDiv;
          var remElemParent = Polymer.dom(remElem).parentNode;
          Polymer.dom(remElemParent).removeChild(remElem);

          var upElement = e.target;
          while(upElement.nodeName !== "AT-CARBON-ICON-BUTTON") {
            upElement = upElement.parentElement;
          }
          var updatePath = upElement.getAttribute('data-update-path');
          self.removeCondition(updatePath);
        });
        Polymer.dom(conditionsDiv).appendChild(removeLink);

        // ------------------------------
        // build the rules or conditions for this node
        // ------------------------------
        for (index = 0; index < length; index += 1) {
          condition = data.conditions[index];
          isLeaf = condition.kind === undefined;
          var levelPath = this.createPath(updatePath, "conditions." + index);

          if (isLeaf) {
            this.buildLeafHtml(conditionsDiv, fields, condition, levelPath); 
          } else {
            this.buildNodeHtml(conditionsDiv, fields, condition, levelPath);
          }
        }
      },
      // ------------------------------
      // builds the html structure for the rule
      // ------------------------------
      buildLeafHtml: function(htmlContainer, fields, data, updatePath) {
        var self = this;
        data.compareTo = data.compareTo !== undefined ? data.compareTo : 'text';
        if (data.compareTo !== 'text' && data.compareTo !== 'field') {
          data.compareTo = 'text';
        }

        // ------------------------------
        // create the html container for the rule
        // ------------------------------
        var leafContainer = document.createElement('div');
        Polymer.dom(leafContainer).classList.add('rule');
        Polymer.dom(leafContainer).setAttribute('data-update-path', updatePath);
        Polymer.dom(htmlContainer).appendChild(leafContainer);

        // ------------------------------
        // create the remove button
        // ------------------------------
        var removeLink = document.createElement('at-carbon-icon-button');        
        Polymer.dom(removeLink).classList.add('-arc-remove');
        removeLink.icon = "now:trash";
        removeLink.color = "red";
        Polymer.dom(removeLink).setAttribute('data-update-path', updatePath);
        Polymer.dom(leafContainer).appendChild(removeLink);

        removeLink.addEventListener('click', function(event) {
          var remElem = leafContainer;
          var remElemParent = Polymer.dom(remElem).parentNode;
          Polymer.dom(remElemParent).removeChild(remElem);

          var upElement = event.target;
          while(upElement.nodeName !== "AT-CARBON-ICON-BUTTON") {
            upElement = upElement.parentElement;
          }
          var updatePath = upElement.getAttribute('data-update-path');
          self.removeCondition(updatePath);
        });

        // ------------------------------
        // create the select element for selecting the field(s)
        // ------------------------------
        var fieldSelect = this.createFieldSelect(fields, data, updatePath);
        Polymer.dom(leafContainer).insertBefore(fieldSelect, removeLink);

        fieldSelect.addEventListener('value-changed', function(event) {
          var _fields = fields;
          var _container = leafContainer;
          var updatePath = _container.getAttribute('data-update-path');
          var data = self.get(updatePath, self.value);
          var target = event.target;
          var selectedFieldName = target.value;
          var selectedField = self.getFieldByName(selectedFieldName);

          // we want first operator in the operators list for the selected field to be selected by default
          // for _any field this is ifchanged; for other fields this is equalTo
          data.operator = selectedField.operators[0].name;
          // we need to update rule-conditions value because previous value for operator property is invalid
          self.set(updatePath, data);

          var operatorSelect = self.createOperatorSelect(_container, selectedField, data, updatePath);
          self._handleValueChanged(event);
        });

        // ------------------------------
        // create the select element for selecting operator(s)
        // ------------------------------
        var selectedFieldName = fieldSelect.value;
        var selectedField = this.getFieldByName(selectedFieldName);
        var operatorSelect = this.createOperatorSelect(leafContainer, selectedField, data, updatePath);
      },
      // ------------------------------
      // creates the select with available fields
      // ------------------------------
      createFieldSelect: function(fields, data, updatePath) {
        var fieldSelect = document.createElement('at-form-lookup');
        Polymer.dom(fieldSelect).classList.add('field');
        Polymer.dom(fieldSelect).setAttribute('data-update-path', this.createPath(updatePath, 'name'));
        var index;
        var length = fields.length;
        var field; 
        var option;

        var xvaluelist = [];

        for (index = 0; index < length; index += 1) {
          field = fields[index];
          xvaluelist.push({ title: field.label, value: field.name, options: field.options });
        }
        fieldSelect.xvaluelist = xvaluelist;
        fieldSelect.value = data.name;
        return fieldSelect;
      },
      // ------------------------------
      // creates a select element populated with operators for the selected field
      // ------------------------------
      createOperatorSelect: function(htmlContainer, selectedField, data, updatePath) {
        var prevOperatorSelect = Polymer.dom(htmlContainer).querySelector('.operator');
        if (prevOperatorSelect) {
          Polymer.dom(htmlContainer).removeChild(prevOperatorSelect);
        }
        var removeButton = Polymer.dom(htmlContainer).querySelector('.-arc-remove');

        var operators = selectedField.operators;
        var i, length = operators.length,
          operator, option;
        var operatorSelect = document.createElement('at-form-lookup');
        Polymer.dom(operatorSelect).setAttribute('data-update-path', this.createPath(updatePath, 'operator'));
        Polymer.dom(operatorSelect).classList.add('operator');
        var xvaluelist = [];

        for (i = 0; i < length; i += 1) {
          operator = operators[i];
          xvaluelist.push({ title: operator.label, value: operator.name, fieldType: operator.fieldType, compareTo: data.compareTo});
        }
        operatorSelect.xvaluelist = xvaluelist;
        operatorSelect.value = data.operator;

        Polymer.dom(htmlContainer).insertBefore(operatorSelect, removeButton);

        var selectedOperatorOption = operatorSelect.selectedItems.length ? operatorSelect.selectedItems[0] : false;      
        var self = this;

        operatorSelect.addEventListener('selected-items-changed', function(event) {
          var _container = htmlContainer;
          var _data = data;
          var updatePath = _container.getAttribute('data-update-path');
          var target = event.target;
          var selectedOperatorOption = target.selectedItems[0];

          self.createOperatorCompareToSelect(_container, selectedOperatorOption, _data, updatePath);
          self._handleValueChanged(event);
        });
        if (selectedOperatorOption) {
          this.createOperatorCompareToSelect(htmlContainer, selectedOperatorOption, data, updatePath);
        } else {
          // we are rendering for at-form-section so we need to clear previous html
          prevOperatorSelect = Polymer.dom(htmlContainer).querySelector('.operator');
          if (prevOperatorSelect) {
            Polymer.dom(htmlContainer).removeChild(prevOperatorSelect);
          }
          var prevCompareTo = Polymer.dom(htmlContainer).querySelector('.compareTo');
          if (prevCompareTo) {
            Polymer.dom(htmlContainer).removeChild(prevCompareTo);
          }
          var prevValueHtml = Polymer.dom(htmlContainer).querySelector('.value');
          if (prevValueHtml) {
            Polymer.dom(htmlContainer).removeChild(prevValueHtml);
          }
        }
      },
      // ------------------------------
      // creates select field with static and field options
      // ------------------------------
      createOperatorCompareToSelect: function(htmlContainer, selectedOperatorOption, data, updatePath) {
        var prevCompareTo = Polymer.dom(htmlContainer).querySelector('.compareTo');
        if (prevCompareTo) {
          Polymer.dom(htmlContainer).removeChild(prevCompareTo);
        }

        var removeButton = Polymer.dom(htmlContainer).querySelector('.-arc-remove');
        var fieldSelect = Polymer.dom(htmlContainer).querySelector('.field');
        var selectedFieldName = fieldSelect.value;
        var selectedField = this.getFieldByName(selectedFieldName);

        var fieldType = selectedOperatorOption.fieldType;
        var compareTo = selectedOperatorOption.compareTo;
        var options = selectedField.options,
          i, length = options.length,
          option, htmlOption;

        var result = '';
        if (fieldType === "select") {
          result = document.createElement('at-form-lookup');
          Polymer.dom(result).classList.add('compareTo');
          Polymer.dom(result).setAttribute('data-update-path', this.createPath(updatePath, 'compareTo'));
          var xvaluelist = [];
          for (var i = 0; i < length; i++) {
            option = options[i];
            xvaluelist.push({ 
              title: option.label || option.name, 
              value: option.name, 
              fieldType: option.fieldType,
              options: option.options
            });
          }
          result.xvaluelist = xvaluelist;
          result.value = compareTo === 'text' ? 'static' : compareTo;

          Polymer.dom(htmlContainer).insertBefore(result, removeButton);
          var self = this;
          result.addEventListener('value-changed', function(event) {
            var _container = htmlContainer;
            var target = event.target;
            var parentNode = Polymer.dom(target).parentNode;
            var updatePath = parentNode.getAttribute('data-update-path');
            var _data = data;
            var selectedCompareTo = target.selectedItems[0];

            self.createValueHtml(_container, selectedCompareTo, data, updatePath);
            self._handleValueChanged(event);
          });

          var selectedCompareTo = result.selectedItems[0];
          this.createValueHtml(htmlContainer, selectedCompareTo, data, updatePath);
        } else {
          var prevValueHtml = Polymer.dom(htmlContainer).querySelector('.value');
          if (prevValueHtml) {
            Polymer.dom(htmlContainer).removeChild(prevValueHtml);
          }
        }
      },
      // ------------------------------
      // creates html for the value part; it creates either a text, textarea or select
      // last part of the "waterfall cascade"
      // ------------------------------
      createValueHtml: function(htmlContainer, selectedCompareTo, data, updatePath) {
        var prevValueHtml = Polymer.dom(htmlContainer).querySelector('.value');
        if (prevValueHtml) {
          Polymer.dom(htmlContainer).removeChild(prevValueHtml);
        }
        var removeButton = Polymer.dom(htmlContainer).querySelector('.-arc-remove');

        var result = '';
        var fieldType = selectedCompareTo.fieldType;
        var options = selectedCompareTo.options;

        if (fieldType === "select") {
          result = document.createElement('at-form-lookup');
          var xvaluelist = [];
          for (var i = 0; i < options.length; i++) {
            var option = options[i];
            var optionLabel = option.label || option.title || option.name;
            var optionName = option.name || option.value;
            xvaluelist.push({ title: optionLabel, value: optionName });
          }
          result.xvaluelist = xvaluelist;
          result.value = data.value;
          result.addEventListener('value-changed', this._handleValueChanged.bind(this));
        } else {
          switch (fieldType) {
            case "boolean":
            case "toggle":
              result = document.createElement('at-form-checkbox');
              if (fieldType === "toggle") {
                result.xtype = "toggle";
              }
              break;
            case "code":
              result = document.createElement('at-form-codemirror');
              break;
            case "date":
            case "time":
            case "datetime":
              result = document.createElement('at-form-date');
              result.xtype = fieldType;
              break;
            case "daterange":
              result = document.createElement('at-form-daterange');
              break;
            case "file":
              result = document.createElement('at-form-file');
              break;
            case "image":
              result = document.createElement('at-form-image');
              break;
            case "enum":
              result = document.createElement('at-form-lookup');
              result.xvaluelist = options;
              break;
            case "lookup":
              result = document.createElement('at-form-lookup');
              break;
            case "marked":
              result = document.createElement('at-form-markdown');
              break;
            case "number":
              result = document.createElement('at-form-number');
              break;
            case "password":
              result = document.createElement('at-form-password');
              break;
            case "radio":
              result = document.createElement('at-form-radio');
              result.xvaluelist = options;
              break;
            case "section":
              // at-form-section doesn't make sense in conditions
              result = document.createElement('div');
              break;
            case "string":
              result = document.createElement('at-form-text');
              break;
            case "textarea":
              result = document.createElement('at-form-textarea');
              break;
            case "random":
              result = document.createElement('at-form-random');
              break;  
            case "cron":
              result = document.createElement('at-form-cron');
              break;                
          }
          Polymer.dom(result).classList.add('inline-element');
          result.addEventListener('value-changed', this._handleValueChanged.bind(this));
        }
        Polymer.dom(result).classList.add('value');
        Polymer.dom(result).setAttribute('data-update-path', this.createPath(updatePath, 'value'));
        result.value = data.value;
        Polymer.dom(htmlContainer).insertBefore(result, removeButton);
      },

      _handleValueChanged: function(event) {
        event.stopPropagation();
        var target = event.target;
        var updatePath = target.getAttribute('data-update-path');
        var value = target.value;
        this.set(updatePath, value, this.value);
        this.fire('value-changed', {
          value: this.value
        }, {
          bubbles: false
        });
      },

      getFieldByName: function(fieldName) {
        var fields = this.config,
          i,
          length = fields.length,
          field;

        for (i = 0; i < length; i += 1) {
          field = fields[i];
          if (field.name === fieldName) {
            break;
          }
        }

        return field;
      },
      createSelectOption: function(value, text, selected) {
        var option = document.createElement("option");
        option.value = value;
        option.text = text;
        option.selected = selected;

        return option;
      },
      createPath: function(previousPath, step) {
          var result = '';
          if (previousPath === '') {
            result = step;
          } else {
            result = previousPath + "." + step;
          }

          return result;
        }
        // ----------------------------------------
        // end of at-rule-conditions html helper functions
        // ----------------------------------------
    });
    // ----------------------------------------
    // end of at-rule-conditions definition
    // ----------------------------------------
  </script>
</dom-module>
